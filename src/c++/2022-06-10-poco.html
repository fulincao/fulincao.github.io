<p>了解一下apollo mainboard的启动流程,觉得挺灵活的。在此记录一下,并自己简单实现了一下demo。</p>

<h3 id="mainboard-启动流程">mainboard 启动流程</h3>

<ol>
  <li>启动命令<strong>mainboad -d xxx.dag</strong></li>
  <li>读取dag文件，尤其是module_library字段和class_name</li>
  <li>通过poco动态加载module_library，并在module_library中加载class_name</li>
  <li>实例化对象Component</li>
  <li>调用其Init,Proc函数
mainboard根据dag文件动态加载不同的class，执行不同的操作。具有极大的灵活方便且统一调度。同时所有component都基于一个基类ComponentBase，约束了其行为。</li>
</ol>

<ul>
  <li>示例dag文件
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="n">module_config</span> <span class="p">{</span>
  <span class="n">module_library</span> <span class="p">:</span> <span class="s">"XXXX.so"</span>
  <span class="n">components</span> <span class="p">{</span>
      <span class="n">class_name</span> <span class="p">:</span> <span class="s">"XXXX"</span>
      <span class="n">config</span> <span class="p">{</span>
          <span class="n">name</span><span class="p">:</span> <span class="s">"xxxx"</span>
          <span class="n">config_file_path</span> <span class="p">:</span> <span class="s">"xxxx.pb.txt"</span>
      <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h3 id="基于poco的demo">基于poco的demo</h3>

<ul>
  <li>安装poco
    <ol>
      <li>apt安装sudo apt install libpoco-dev</li>
      <li>源码安装见<a href="https://github.com/pocoproject/poco">POCO</a></li>
      <li>poco SharedLibrary介绍<a href="https://pocoproject.org/slides/120-SharedLibraries.pdf">SaredLibrary</a></li>
    </ol>
  </li>
  <li>简单demo</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre></td><td class="rouge-code"><pre><span class="cm">/******************************************************************************
 * Copyright 2022  All Rights Reserved.
 ********************************************************/</span>
<span class="cp">#include &lt;iostream&gt;
#include &lt;string&gt;
</span>
<span class="cp">#include &lt;Poco/ClassLibrary.h&gt;   // NOLINT
#include &lt;Poco/ClassLoader.h&gt;    // NOLINT
#include &lt;Poco/SharedLibrary.h&gt;  // NOLINT
</span>
<span class="k">class</span> <span class="nc">Component</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="n">Component</span><span class="p">()</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="o">~</span><span class="n">Component</span><span class="p">()</span> <span class="p">{}</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Init</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Proc</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">RtkComponent</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Component</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="kt">bool</span> <span class="n">Init</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">Proc</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"hello rtk component"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">CameraComponent</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Component</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="kt">bool</span> <span class="n">Init</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">bool</span> <span class="n">Proc</span><span class="p">()</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"hello camera component"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="n">POCO_BEGIN_MANIFEST</span><span class="p">(</span><span class="n">Component</span><span class="p">)</span>
<span class="n">POCO_EXPORT_CLASS</span><span class="p">(</span><span class="n">RtkComponent</span><span class="p">)</span>
<span class="n">POCO_EXPORT_CLASS</span><span class="p">(</span><span class="n">CameraComponent</span><span class="p">)</span>
<span class="n">POCO_END_MANIFEST</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"args not enough"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"example: test_poco library_path classname"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">library_path</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">classname</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"load library:"</span> <span class="o">&lt;&lt;</span> <span class="n">library_path</span>
            <span class="o">&lt;&lt;</span> <span class="s">" , load classname: "</span> <span class="o">&lt;&lt;</span> <span class="n">classname</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="n">Poco</span><span class="o">::</span><span class="n">ClassLoader</span><span class="o">&lt;</span><span class="n">Component</span><span class="o">&gt;</span> <span class="n">clc</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="n">clc</span><span class="p">.</span><span class="n">loadLibrary</span><span class="p">(</span><span class="n">library_path</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="k">const</span> <span class="n">Poco</span><span class="o">::</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">displayText</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">auto</span><span class="o">*</span> <span class="n">base</span> <span class="o">=</span> <span class="n">clc</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">classname</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">base</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">base</span><span class="o">-&gt;</span><span class="n">Proc</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="c1">// ./test_poco ./libcomponent.so CameraComponent</span>
<span class="c1">// ./test_poco ./libcomponent.so RtkComponent</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<ul>
  <li>cmake文件</li>
</ul>

<div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nb">project</span><span class="p">(</span>test<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>test_poco test_poco.cpp<span class="p">)</span>

<span class="nb">add_library</span><span class="p">(</span>component SHARED test_poco.cpp<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span>test_poco
    PocoFoundation
<span class="p">)</span>

<span class="nb">target_link_libraries</span><span class="p">(</span>component
    PocoFoundation
<span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
