<h1 id="can解析">can解析</h1>
<p>描述can解析流程</p>
<h2 id="数据">数据</h2>

<p>我们一般拿到的can数据一般都是这种样子的</p>

<table>
  <thead>
    <tr>
      <th>CAN ID</th>
      <th>CAN DATA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0x60b</td>
      <td>0x11 0x22 0x33 0x44 0x55 0x66 0x77 0x88</td>
    </tr>
  </tbody>
</table>

<p>这便是一条完整的can帧, 由id和data组成.其在linux中结构定义如下:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">#include &lt;linux/can.h&gt;
</span>
<span class="cm">/* CAN payload length and DLC definitions according to ISO 11898-1 */</span>
<span class="cp">#define CAN_MAX_DLC 8
#define CAN_MAX_DLEN 8
</span>

<span class="cm">/* special address description flags for the CAN_ID */</span>
<span class="cp">#define CAN_EFF_FLAG 0x80000000U </span><span class="cm">/* EFF/SFF is set in the MSB */</span><span class="cp">
#define CAN_RTR_FLAG 0x40000000U </span><span class="cm">/* remote transmission request */</span><span class="cp">
#define CAN_ERR_FLAG 0x20000000U </span><span class="cm">/* error message frame */</span><span class="cp">
</span>

<span class="k">struct</span> <span class="nc">can_frame</span> <span class="p">{</span>
    <span class="n">canid_t</span> <span class="n">can_id</span><span class="p">;</span>  <span class="cm">/* 32 bit CAN_ID + EFF/RTR/ERR flags */</span>
    <span class="n">__u8</span>    <span class="n">can_dlc</span><span class="p">;</span> <span class="cm">/* frame payload length in byte (0 .. CAN_MAX_DLEN) */</span>
    <span class="n">__u8</span>    <span class="n">__pad</span><span class="p">;</span>   <span class="cm">/* padding */</span>
    <span class="n">__u8</span>    <span class="n">__res0</span><span class="p">;</span>  <span class="cm">/* reserved / padding */</span>
    <span class="n">__u8</span>    <span class="n">__res1</span><span class="p">;</span>  <span class="cm">/* reserved / padding */</span>
    <span class="n">__u8</span>    <span class="n">data</span><span class="p">[</span><span class="n">CAN_MAX_DLEN</span><span class="p">]</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)));</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>can帧的主要几类:</p>

<ul>
  <li>
    <p><strong>数据帧-标准帧</strong>: 长度11位,最大值为0x7ff.</p>
  </li>
  <li>
    <p><strong>数据帧-扩展帧</strong>: 长度29位, 可通过canid &amp; CAN_EFF_FLAG == 1 判断.</p>
  </li>
  <li><strong>错误帧</strong>: 通过 CAN_ERR_FLAG 判断</li>
  <li><strong>远程帧</strong>: 通过 CAN_RTR_FLAG 判断</li>
</ul>

<p>其中我们看到最多的是数据帧, 其他帧基本没有看到过.</p>

<h2 id="dbc">dbc</h2>

<p>有了数据之后,如何解码出我们所需要的信息呢? 通常情况都是通过dbc来编码或者解码的.DBC是Database Can的缩写，其代表的是CAN的数据库文件，在这个文件中把CAN通讯的信息定义完整.</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>BO_ 1547 Obj_1_General: 8 ARS_ISF
 SG_ Obj_DynProp : 50|3@0+ (1,0) [0|7] ""  ExternalUnit
 SG_ Obj_RCS : 63|8@0+ (0.5,-64) [-64|63.5] "dBm²"  ExternalUnit
 SG_ Obj_VrelLat : 45|9@0+ (0.25,-64) [-64|63.75] "m/s"  ExternalUnit
 SG_ Obj_ID : 7|8@0+ (1,0) [0|255] ""  ExternalUnit
 SG_ Obj_DistLong : 15|13@0+ (0.2,-500) [-500|1138.2] "m"  ExternalUnit
 SG_ Obj_VrelLong : 39|10@0+ (0.25,-128) [-128|127.75] "m/s"  ExternalUnit
 SG_ Obj_DistLat : 18|11@0+ (-0.2,204.6) [-204.8|204.6] "m"  ExternalUnit

</pre></td></tr></tbody></table></code></pre></div></div>

<p>上面展示了一段ars的dbc中对canid为1547的can帧描述.其中主要有<strong>BO_</strong> 报文, <strong>SG_</strong> 信号.</p>

<p>一个报文下会有多个信号. 一个报文就是一个can帧,其数据域长度为8字节64位(见前面定义).对于信号,每一行都相信的描述了该信号在数据域中的位置,解码方式等.</p>

<h3 id="bo_-报文">BO_ (报文)</h3>

<p>基本格式如下:
<strong>BO_ MessageId MessageName: MessageSize Transmitter</strong></p>

<ol>
  <li>BO_为关键字，表示报文；</li>
  <li>MessageId为定义的报文ID，是以10进制数表示；</li>
  <li>MessageName表示该报文的名字</li>
  <li>MessageSize表示该报文数据域字节数，为无符号整型数据；</li>
  <li>Transmitter表示发送该报文的网络节点；如果该报文没有指定发送节点，则该值需设置为” Vector__XXX”或者不写</li>
</ol>

<p>以1547报文举例说明:
<strong>BO_ 1547 Obj_1_General: 8 ARS_ISF</strong></p>

<table>
  <thead>
    <tr>
      <th>定义</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>BO_</td>
      <td>报文关键字</td>
    </tr>
    <tr>
      <td>1547</td>
      <td>can id 16进制为0x60b</td>
    </tr>
    <tr>
      <td>Obj_1_General</td>
      <td>报文名字</td>
    </tr>
    <tr>
      <td>8</td>
      <td>报文数据域字节数</td>
    </tr>
    <tr>
      <td>ARS_ISF</td>
      <td>发送该报文的节点</td>
    </tr>
  </tbody>
</table>

<h3 id="sg_-信号">SG_ (信号)</h3>

<p>基本格式如下:
<strong>SG_ SignalName : StartBit|SignalSize@ByteOrder ValueType (Factor,Offset) [Min|Max] Unit Receiver</strong></p>

<ol>
  <li>SG_为关键字，表示信号；</li>
  <li>SignalName、 StartBit、 SignalSize分别表示该信号的名字、起始位、信号长度；</li>
  <li>ByteOrder表示信号的字节顺序：0代表Motorola格式(大端序)，1代表Intel格式(小端序)；</li>
  <li>ValueType 表示该信号的数值类型：+表示无符号数，-表示有符号数；</li>
  <li>Factor表示因子，Offset表示偏移量；这两个值于该信号的原始值与物理值之间的转换。转换如下：物理值=原始值*因子+偏移量；</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>Min</td>
          <td>Max表示该信号的最小值和最大值，即指定了该信号值的范围；这两个值为double类型；</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>Unit表示该信号的单位，为字符串类型；</li>
  <li>Receiver表示该信号的接收节点；若该信号没有指定的接收节点，则必须设置为” Vector__XXX”</li>
</ol>

<p>举例如下:
<strong>SG_ Obj_DistLat : 18|11@0+ (-0.2,204.6) [-204.8|204.6] “m”  ExternalUnit</strong></p>

<table>
  <thead>
    <tr>
      <th>定义</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>SG_</td>
      <td>信号关键字</td>
    </tr>
    <tr>
      <td>Obj_DistLat</td>
      <td>信号名</td>
    </tr>
    <tr>
      <td>18</td>
      <td>起始位</td>
    </tr>
    <tr>
      <td>11</td>
      <td>长度</td>
    </tr>
    <tr>
      <td>0</td>
      <td>motorola格式(大端序)</td>
    </tr>
    <tr>
      <td>+</td>
      <td>无符号数</td>
    </tr>
    <tr>
      <td>-0.2</td>
      <td>缩放因子</td>
    </tr>
    <tr>
      <td>204.6</td>
      <td>偏移量</td>
    </tr>
    <tr>
      <td>-204.8</td>
      <td>最小值</td>
    </tr>
    <tr>
      <td>204.6</td>
      <td>最大值</td>
    </tr>
    <tr>
      <td>m</td>
      <td>单位</td>
    </tr>
    <tr>
      <td>ExternalUnit</td>
      <td>接收节点</td>
    </tr>
  </tbody>
</table>

<h2 id="解析">解析</h2>

<p>通过dbc或者协议文档获取了报文和信号的编解码信息,然后就可以解析出明文.这里还是以conti的ars 408雷达举例.</p>

<h3 id="大端序列">大端序列</h3>

<p>cve采集到的一条ars报文:
<strong>0x60b 00 4e a4 01 80 20 01 7f</strong></p>

<ul>
  <li>
    <p>首先构建位图</p>

    <p>将8字节64位数据转成二进制,依次展开
  <strong>大端序列从左往右编号, 小端序从右往左编号</strong>, 从上到下依次增加</p>

    <table>
      <thead>
        <tr>
          <th>位序编号</th>
          <th>0</th>
          <th>1</th>
          <th>2</th>
          <th>3</th>
          <th>4</th>
          <th>5</th>
          <th>6</th>
          <th>7</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x4e</strong></td>
          <td>0</td>
          <td>1</td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0xa4</strong></td>
          <td>1</td>
          <td>0</td>
          <td>1</td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x01</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
        </tr>
        <tr>
          <td><strong>0x80</strong></td>
          <td>1</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x20</strong></td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x01</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
        </tr>
        <tr>
          <td><strong>0x7f</strong></td>
          <td>0</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>根据信号描述获取对应字节
这里以Obj_DistLat信号作为示例.如上所示,在dbc中定义的起始位start_bit = 18, 长度length = 11.
<strong>大端序的实际起始位需要转换, 小端序无需转换</strong>,转换如下:</p>

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">start_bit</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">start_bit</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">start_bit</span> <span class="o">%</span> <span class="mi">8</span><span class="p">));</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>转换之后为 stat_bit = 21, length = 11,</p>
    <ul>
      <li>然后从位图中找到这11位是 0xa4的后3位 加上 0x01的8位即:100 00000001</li>
      <li>然后按照大端序排列为 10000000001, 即10进制为val = 1025;</li>
      <li>由于当前信号是无符号数据,所以补码等于源码,如果是有符号数且是负数的话需要取反加1计算(后面会介绍)</li>
      <li>缩放 scale = -0.2, offset = 204.6, val = val * -0.2 + 204.6 = -0.4</li>
      <li>即算得 Obj_DistLat在当前帧的值为-0.4, 其他信号按此步骤计算可得</li>
    </ul>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="p">{</span><span class="w">
    </span><span class="nl">"Obj_DistLong"</span><span class="p">:</span><span class="w"> </span><span class="mf">3.2000000000000455</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_VrelLong"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_DynProp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_ID"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_RCS"</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.5</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_VrelLat"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> 
    </span><span class="nl">"Obj_DistLat"</span><span class="p">:</span><span class="w"> </span><span class="mf">-0.4000000000000057</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>至此当前帧解析完毕.</p>
  </li>
</ul>

<h3 id="小端序列">小端序列</h3>

<p>cve采集到的一条x1j报文:
<strong>0x76d 00 00 00 00 ae 1f 00 00</strong></p>

<p>其0x76d报文定义如下:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>
BO_ 1901 KeyCarFrameA1: 8 MINIEYE_TRANSMITTER
 SG_ on_route : 1|1@1+ (1,0) [0|1] "" Vector__XXX
 SG_ TargetVehicle_Status : 20|4@1+ (1,0) [0|15] "" Vector__XXX
 SG_ TargetVehicle_Width : 24|8@1+ (0.05,0) [0|12.5] "M" Vector__XXX
 SG_ FCW : 0|1@1+ (1,0) [0|1] ""  ADAS
 SG_ Vehicle_ID : 2|6@1+ (1,0) [0|63] ""  ADAS
 SG_ TargetVehicle_PosX : 8|12@1+ (0.0625,0) [0|250] "m"  ADAS
 SG_ TargetVehicle_PosY : 32|10@1- (0.0625,0) [-31.9375|31.9375] "m"  ADAS
 SG_ TargetVehicle_Type : 48|3@1+ (1,0) [0|7] ""  ADAS
</pre></td></tr></tbody></table></code></pre></div></div>

<p>这里考虑TargetVehicle_PosY, 由上面分析可得 start_bit = 32, length = 10, scale = 0.0625, offset = 0,小端序, 有符号.</p>

<ul>
  <li>
    <p>构建位图
  此时<strong>位序与大端序号刚刚相反</strong></p>

    <table>
      <thead>
        <tr>
          <th>位序编号</th>
          <th>7</th>
          <th>6</th>
          <th>5</th>
          <th>4</th>
          <th>3</th>
          <th>2</th>
          <th>1</th>
          <th>0</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0xae</strong></td>
          <td>1</td>
          <td>0</td>
          <td>1</td>
          <td>0</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x1f</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
          <td>1</td>
        </tr>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
        <tr>
          <td><strong>0x00</strong></td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
          <td>0</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>然后从位图中找到这10位是 0xae 加上 0xff的后两位 即:10101110 11</li>
  <li>然后按照小端序排列为 1110101110, 即10进制为val = 942;</li>
  <li>由于当前信号是有符号数据,且最高位为1,则说明该值为负数,需要取补码,补码为原码取反加1,则:val = ((~val) + 1) *-1 = -82</li>
  <li>缩放加偏差为val = val * 0.0625 + 0 = -5.125</li>
  <li>
    <p>即算得 TargetVehicle_PosY在当前帧的值为-5.125, 其他信号按此步骤计算可得</p>

    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="w">  </span><span class="p">{</span><span class="w">
      </span><span class="nl">"TargetVehicle_PosX"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"TargetVehicle_Status"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"TargetVehicle_Type"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"FCW"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"on_route"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"TargetVehicle_PosY"</span><span class="p">:</span><span class="w"> </span><span class="mf">-5.125</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"Vehicle_ID"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"TargetVehicle_Width"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h3 id="实现">实现</h3>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
</pre></td><td class="rouge-code"><pre>
<span class="c1">// 定义数据结构</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">can_frame</span><span class="p">{</span>
    <span class="kt">int</span> <span class="n">can_id</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">can_data</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span><span class="n">can_frame</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">singal</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">scale</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">offest</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">min_val</span><span class="p">;</span>
    <span class="kt">float</span> <span class="n">max_val</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">little_order</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">is_unsigned</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span><span class="n">singal</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">dbc_message</span>
<span class="p">{</span>
    <span class="n">string</span> <span class="n">name</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">can_id</span><span class="p">;</span>
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">singal</span><span class="o">&gt;</span> <span class="n">singals</span><span class="p">;</span>
<span class="p">}</span><span class="n">dbc_message</span><span class="p">;</span>

<span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">dbc_message</span><span class="o">&gt;</span> <span class="n">dbc</span><span class="p">;</span> 
<span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">val_table</span><span class="p">;</span>

<span class="c1">// 加载dbc</span>
<span class="kt">void</span> <span class="nf">add_dbc</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">dbc_path</span><span class="p">){</span>
        <span class="kt">FILE</span><span class="o">*</span> <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">dbc_path</span><span class="p">,</span> <span class="s">"r"</span><span class="p">);</span>

        <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">10086</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">last_bo_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">fgets</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10085</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
            <span class="n">string</span> <span class="n">target</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
            <span class="n">target</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">target</span><span class="p">.</span><span class="n">find_first_not_of</span><span class="p">(</span><span class="s">" "</span><span class="p">));</span>
            <span class="n">target</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">find_last_not_of</span><span class="p">(</span><span class="s">" "</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">target</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s">"BO_"</span><span class="p">){</span>
                <span class="n">regex</span> <span class="n">reg</span><span class="p">(</span><span class="s">"BO_</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">d+)</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">w+):"</span><span class="p">);</span>
                <span class="n">smatch</span> <span class="n">sm</span><span class="p">;</span>
                <span class="n">regex_search</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">continue</span><span class="p">;</span>
               
                <span class="n">string</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
                <span class="kt">long</span> <span class="kt">long</span> <span class="n">can_id</span> <span class="o">=</span> <span class="n">atoll</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="k">if</span><span class="p">(</span><span class="n">can_id</span> <span class="o">&gt;</span> <span class="mh">0x7ff</span><span class="p">)</span> <span class="n">can_id</span> <span class="o">-=</span> <span class="mh">0x80000000</span><span class="p">;</span>    


                <span class="k">if</span> <span class="p">(</span><span class="n">dbc</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">can_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dbc</span><span class="p">.</span><span class="n">end</span><span class="p">())</span>
                <span class="p">{</span>
                    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"can_id conflict "</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="n">dbc_message</span> <span class="n">dm</span><span class="p">;</span>
                <span class="n">dm</span><span class="p">.</span><span class="n">can_id</span> <span class="o">=</span> <span class="n">can_id</span><span class="p">;</span>
                <span class="n">dm</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
                <span class="n">dbc</span><span class="p">[</span><span class="n">can_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">dm</span><span class="p">;</span>
                <span class="n">last_bo_id</span> <span class="o">=</span> <span class="n">can_id</span><span class="p">;</span>

            <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="s">"SG_"</span><span class="p">){</span>
                <span class="n">regex</span> <span class="n">reg</span><span class="p">(</span><span class="s">"SG_</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">w+)</span><span class="se">\\</span><span class="s">s+:</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">d+)</span><span class="se">\\</span><span class="s">|(</span><span class="se">\\</span><span class="s">d+)@(</span><span class="se">\\</span><span class="s">d+)(.)</span><span class="se">\\</span><span class="s">s+</span><span class="se">\\</span><span class="s">((.+?),(.+?)</span><span class="se">\\</span><span class="s">)</span><span class="se">\\</span><span class="s">s+</span><span class="se">\\</span><span class="s">[(.*?)</span><span class="se">\\</span><span class="s">|(.*?)</span><span class="se">\\</span><span class="s">]</span><span class="se">\\</span><span class="s">s+</span><span class="se">\"</span><span class="s">(.*?)</span><span class="se">\"</span><span class="s">"</span><span class="p">);</span>
                <span class="n">smatch</span> <span class="n">sm</span><span class="p">;</span>
                <span class="n">regex_search</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">continue</span><span class="p">;</span>
                <span class="k">if</span><span class="p">(</span> <span class="n">last_bo_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                <span class="n">singal</span> <span class="n">s</span><span class="p">;</span>
                <span class="n">s</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
                <span class="n">strcpy</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">little_order</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">4</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">is_unsigned</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="mi">5</span><span class="p">].</span><span class="n">str</span><span class="p">()</span> <span class="o">==</span> <span class="s">"+"</span> <span class="o">?</span> <span class="nb">true</span> <span class="o">:</span> <span class="nb">false</span><span class="p">;</span>
                <span class="n">s</span><span class="p">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">offest</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">min_val</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">s</span><span class="p">.</span><span class="n">max_val</span> <span class="o">=</span> <span class="n">atof</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="c1">// sm[9] type</span>
                <span class="n">dbc</span><span class="p">[</span><span class="n">last_bo_id</span><span class="p">].</span><span class="n">singals</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">target</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="s">"VAL_"</span><span class="p">){</span>
                <span class="n">regex</span> <span class="n">reg</span><span class="p">(</span><span class="s">"VAL_</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">d+)</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">w+)</span><span class="se">\\</span><span class="s">s+(</span><span class="se">\\</span><span class="s">d+</span><span class="se">\\</span><span class="s">s+</span><span class="se">\"</span><span class="s">.+</span><span class="se">\"\\</span><span class="s">s*)+"</span><span class="p">);</span>
                <span class="n">smatch</span> <span class="n">sm</span><span class="p">;</span>
                <span class="n">regex_search</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="n">sm</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="k">continue</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">can_id</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
                <span class="n">string</span> <span class="n">signal_name</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">str</span><span class="p">();</span>
                <span class="n">string</span> <span class="n">desc</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="n">str</span><span class="p">();</span>
                <span class="n">string</span> <span class="n">buf</span><span class="p">;</span>
                <span class="kt">int</span> <span class="n">desc_sz</span> <span class="o">=</span> <span class="n">desc</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
                <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">string</span> <span class="n">real_val</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
                <span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">string</span><span class="o">&gt;</span> <span class="n">v</span> <span class="o">=</span> <span class="n">val_table</span><span class="p">[</span><span class="n">to_string</span><span class="p">(</span><span class="n">can_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">signal_name</span><span class="p">];</span>
                <span class="k">for</span><span class="p">(</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">desc_sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">'"'</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
                    <span class="k">if</span><span class="p">(</span> <span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="sc">' '</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="n">cnt</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                                <span class="c1">// cout &lt;&lt; val &lt;&lt; " " &lt;&lt; buf &lt;&lt; endl;</span>
                                <span class="n">v</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
                            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                                <span class="n">val</span> <span class="o">=</span> <span class="n">atoi</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
                            <span class="p">}</span>
                            <span class="n">buf</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
                        <span class="p">}</span>
                        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                    <span class="n">buf</span> <span class="o">+=</span> <span class="n">desc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
                <span class="p">}</span>
                <span class="n">val_table</span><span class="p">[</span><span class="n">to_string</span><span class="p">(</span><span class="n">can_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">"_"</span> <span class="o">+</span> <span class="n">signal_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
                <span class="c1">// for( int i = 0; i &lt; sm.size(); i++ ) cout &lt;&lt; sm[i] &lt;&lt; endl;;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"add dbc file finish..."</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>

<span class="c1">// 解码信号</span>
<span class="kt">double</span> <span class="nf">decode</span><span class="p">(</span><span class="n">singal</span> <span class="n">s</span><span class="p">,</span> <span class="n">can_frame</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
        
        <span class="c1">// for motorola deal start_bit</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">little_order</span><span class="p">)</span> <span class="n">s</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">start</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">7</span> <span class="o">-</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">start</span> <span class="o">%</span> <span class="mi">8</span><span class="p">));</span>

        <span class="kt">uint64_t</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">now_len</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">now_start</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">start</span><span class="p">;</span>
        <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">bit_lengths</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

        <span class="kt">int</span> <span class="n">start_bits</span> <span class="o">=</span> <span class="n">start</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">end_bits</span> <span class="o">=</span> <span class="p">(</span> <span class="n">start</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>


        <span class="c1">// printf("%d %d %d\n", s.start, s.length, s.little_order);</span>
        <span class="c1">// printf("%d %d\n", start_bits, end_bits);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">start_bits</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end_bits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span> 
            <span class="c1">// printf("%d *\n", t.can_data[i]);  </span>
            <span class="kt">int</span> <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">-</span><span class="n">now_start</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="n">dt</span> <span class="o">&lt;=</span> <span class="n">now_len</span><span class="p">){</span>

                <span class="k">if</span><span class="p">(</span><span class="o">!</span> <span class="n">s</span><span class="p">.</span><span class="n">little_order</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">can_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dt</span><span class="p">);</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dt</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span><span class="p">{</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">can_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dt</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">now_len</span> <span class="o">-=</span> <span class="n">dt</span><span class="p">;</span>
                <span class="n">now_start</span> <span class="o">+=</span> <span class="n">dt</span><span class="p">;</span>
                <span class="n">bit_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt</span><span class="p">;</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="kt">int</span> <span class="n">now_dt</span> <span class="o">=</span> <span class="n">now_len</span><span class="p">;</span>
                <span class="c1">// printf("\n%d %d ", dt, now_dt);</span>

                <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="n">s</span><span class="p">.</span><span class="n">little_order</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">can_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">dt</span><span class="p">));</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">now_dt</span><span class="p">);</span>
                <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">can_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">dt</span><span class="p">);</span>

                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">now_dt</span><span class="p">);</span>
                    <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">now_dt</span><span class="p">);</span>
                <span class="p">}</span>

               
                <span class="n">now_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">now_start</span> <span class="o">+=</span> <span class="n">now_dt</span><span class="p">;</span>
                <span class="n">bit_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">now_dt</span><span class="p">;</span>

            <span class="p">}</span>
            <span class="c1">// printf("%d &amp;\n", buf[i]);</span>
        <span class="p">}</span>
        <span class="c1">// printf("\n");</span>

        <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end_bits</span><span class="o">-</span><span class="n">start_bits</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>   
            <span class="kt">uint8_t</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">little_order</span><span class="p">){</span>
                <span class="c1">// if(i + start_bits + 1 &lt;= end_bits) b = bit_lengths[i + start_bits + 1];</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="n">bit_lengths</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">start_bits</span><span class="p">]</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">start_bits</span><span class="p">];</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="c1">// if(end_bits-i-1 &gt;= 0) b = bit_lengths[end_bits-i-1];</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="n">bit_lengths</span><span class="p">[</span><span class="n">end_bits</span><span class="o">-</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">buf</span><span class="p">[</span><span class="n">end_bits</span><span class="o">-</span><span class="n">i</span><span class="p">];</span>
            <span class="p">}</span>
            <span class="c1">// printf("%d * ", res);</span>
        <span class="p">}</span>
        <span class="c1">// printf("res :%d\n", res);</span>
        <span class="kt">double</span> <span class="n">real_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mf">1.0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">is_unsigned</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">~</span><span class="n">res</span><span class="p">;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&lt;&lt;</span> <span class="mi">64</span> <span class="o">-</span> <span class="n">s</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="o">-</span><span class="n">s</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
            <span class="n">debug</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
            <span class="n">real_res</span> <span class="o">=</span> <span class="n">res</span><span class="o">*</span><span class="mf">1.0</span><span class="p">;</span>
            <span class="n">debug</span><span class="p">(</span><span class="n">real_res</span><span class="p">);</span>
            <span class="n">real_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">real_res</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="n">debug</span><span class="p">(</span><span class="n">real_res</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">scale</span><span class="p">);</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">offest</span><span class="p">);</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">max_val</span><span class="p">);</span>
        <span class="n">debug</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">min_val</span><span class="p">);</span>
        <span class="n">real_res</span> <span class="o">=</span> <span class="n">real_res</span> <span class="o">*</span> <span class="n">s</span><span class="p">.</span><span class="n">scale</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">offest</span><span class="p">;</span>
        <span class="n">real_res</span> <span class="o">=</span> <span class="n">real_res</span> <span class="o">&gt;</span> <span class="n">s</span><span class="p">.</span><span class="n">max_val</span> <span class="o">?</span> <span class="n">s</span><span class="p">.</span><span class="n">max_val</span> <span class="o">:</span> <span class="n">real_res</span><span class="p">;</span>
        <span class="n">real_res</span> <span class="o">=</span> <span class="n">real_res</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">min_val</span> <span class="o">?</span> <span class="n">s</span><span class="p">.</span><span class="n">min_val</span> <span class="o">:</span> <span class="n">real_res</span><span class="p">;</span>
        <span class="c1">// printf("\n%f\n", real_res);</span>
        <span class="k">return</span> <span class="n">real_res</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>完整代码见can_parser.cpp, 验证脚本见test_can.py.本人测试cve采集的一组x1j和ars数据时在1e-5的精度下能保证100%准确率. 由于未做大量验证,无法保证完全没有问题.</p>

<h3 id="使用第三方库">使用第三方库</h3>

<h4 id="python---cantools">python - cantools</h4>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>
<span class="kn">import</span> <span class="nn">cantools</span>
<span class="n">dbc</span> <span class="o">=</span> <span class="n">cantools</span><span class="p">.</span><span class="n">database</span><span class="p">.</span><span class="n">load_file</span><span class="p">(</span><span class="s">"/home/cao/work-git/cve/cve/dbc/ARS408.dbc"</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="n">rf</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">"./test_can_parser_data/ars.txt"</span><span class="p">,</span> <span class="s">"r"</span><span class="p">)</span>
<span class="n">ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">frame_id</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dbc</span><span class="p">.</span><span class="n">messages</span><span class="p">]</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rf</span><span class="p">:</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">line</span><span class="p">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">can_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">16</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s">''</span><span class="p">.</span><span class="n">join</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">16</span><span class="p">).</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">'little'</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">[</span><span class="mi">4</span><span class="p">:]])</span>

    <span class="k">if</span> <span class="n">can_id</span> <span class="ow">in</span> <span class="n">ids</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">dbc</span><span class="p">.</span><span class="n">decode_message</span><span class="p">(</span><span class="n">can_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">decode_choices</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>
        <span class="k">break</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="cpp---dbcc">cpp - dbcc</h4>

<ul>
  <li>github链接 : <a href="https://github.com/howerj/dbcc">https://github.com/howerj/dbcc</a></li>
  <li>安装完之后 dbcc ARS408.dbc 便会生成dbc对应的.h 和.c.</li>
  <li>
    <p>使用</p>

    <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre>
  <span class="cp">#include "ARS408.h"
</span>  <span class="cp">#include &lt;linux/can.h&gt;
</span>
  <span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="k">const</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
  <span class="p">{</span>
      <span class="n">can_obj_ars408_h_t</span> <span class="n">t</span><span class="p">;</span>
      <span class="kt">double</span> <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

      <span class="c1">// 1611196534 520939 CAN6 0x60b 00 4e a4 01 80 20 01 7f</span>

      <span class="kt">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">};</span>

      <span class="n">printf</span><span class="p">(</span><span class="s">"%lld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">unpack_message</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="mh">0x60b</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


      <span class="n">ret</span> <span class="o">=</span> <span class="n">decode_can_0x60b_Obj_DistLong</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l</span><span class="p">);</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="n">decode_can_0x60b_Obj_DistLat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lat</span><span class="p">);</span>

      <span class="n">printf</span><span class="p">(</span><span class="s">"ret: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

      <span class="c1">// printf("dist_long: %lf, dis_lat: %lf, tmp: %lf\n", t.can_0x60b_Obj_1_General.Obj_DistLong, t.can_0x60b_Obj_1_General.Obj_DistLat, val);</span>
      <span class="n">printf</span><span class="p">(</span><span class="s">"dist_long: %lf, dis_lat: %lf</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">lat</span><span class="p">);</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>
